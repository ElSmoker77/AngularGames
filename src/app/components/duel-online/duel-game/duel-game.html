<div class="duel-wrapper" *ngIf="state as s; else loading">
  <h2>Duelo online ‚Äì Ronda {{ s.round }}</h2>

  <!-- MARCADOR CENTRADO GRANDE -->
  <div class="scoreboard">
    <span class="score-name">{{ s.players[0].name }}</span>
    <span class="score-value">
      {{ s.players[0].score }}
      <span class="score-separator">-</span>
      {{ s.players[1].score }}
    </span>
    <span class="score-name">{{ s.players[1].name }}</span>
  </div>

  <!-- TIMER ANCHO -->
  <div class="timer-block" *ngIf="timeLeft !== null && !s.isRoundOver; else noTimer">
    <div class="timer-label">
      Tiempo restante: <strong>{{ timeLeft }}s</strong>
    </div>
    <div class="time-bar">
      <div class="time-bar-fill" [style.width.%]="timePercent"></div>
    </div>
  </div>
  <ng-template #noTimer>
    <div class="timer-block timer-ended" *ngIf="s.isRoundOver">
      Ronda terminada
    </div>
  </ng-template>

  <p class="status-text">
    {{ statusText }}
  </p>

  <!-- tarjetas de jugadores -->
  <div class="players-row" *ngIf="myPlayer && opponent">

    <!-- TU CARTA -->
    <div class="player-card my-card" [ngClass]="myPlayer.lastAction">
      <div class="card-header">
        <h3>{{ myPlayer.name }}</h3>
        <div class="action-badge" *ngIf="myPlayer.lastAction as act">
          <span class="action-icon">{{ getActionIcon(act) }}</span>
          <span class="action-text">{{ getActionLabel(act) }}</span>
        </div>
      </div>

      <div class="stat-row">
        <span>Vidas:</span>
        <span class="icon-row">
          <ng-container *ngFor="let full of getHearts(myPlayer)">
            <span class="heart" [class.empty]="!full">‚ù§</span>
          </ng-container>
        </span>
      </div>

      <div class="stat-row">
        <span>Munici√≥n:</span>
        <span class="icon-row">
          <ng-container *ngFor="let full of getAmmoSlots(myPlayer)">
            <span class="bullet" [class.empty]="!full">‚óè</span>
          </ng-container>
        </span>
      </div>

      <p class="points">Puntos: {{ myPlayer.score }}</p>
    </div>

    <!-- CARTA DEL RIVAL -->
    <div class="player-card opponent-card" [ngClass]="opponent.lastAction">
      <div class="card-header">
        <h3>{{ opponent.name }}</h3>
        <div class="action-badge" *ngIf="opponent.lastAction as act">
          <span class="action-icon">{{ getActionIcon(act) }}</span>
          <span class="action-text">{{ getActionLabel(act) }}</span>
        </div>
      </div>

      <div class="stat-row">
        <span>Vidas:</span>
        <span class="icon-row">
          <ng-container *ngFor="let full of getHearts(opponent)">
            <span class="heart" [class.empty]="!full">‚ù§</span>
          </ng-container>
        </span>
      </div>

      <div class="stat-row">
        <span>Munici√≥n:</span>
        <span class="icon-row">
          <ng-container *ngFor="let full of getAmmoSlots(opponent)">
            <span class="bullet" [class.empty]="!full">‚óè</span>
          </ng-container>
        </span>
      </div>

      <p class="points">Puntos: {{ opponent.score }}</p>
    </div>
  </div>

  <!-- Botones de acci√≥n -->
  <div class="actions-panel" *ngIf="!s.isRoundOver">
    <h3>Eleg√≠ tu acci√≥n</h3>
    <div class="buttons">
      <button (click)="doAction('attack')" [disabled]="!canPlay">
        üí• Atacar
      </button>
      <button (click)="doAction('reload')" [disabled]="!canReload">
        üîÑ Recargar
      </button>
      <button (click)="doAction('block')" [disabled]="!canPlay">
        üõ°Ô∏è Bloquear
      </button>
    </div>
  </div>

  <!-- Fin de ronda -->
  <div class="gameover" *ngIf="s.isRoundOver">
    <h2>Ronda terminada</h2>

    <ng-container *ngIf="s.winnerId !== null; else empate">
      <p>
        Ganador de la ronda:
        {{ getWinnerName(s.winnerId) }}
      </p>
    </ng-container>

    <ng-template #empate>
      <p>La ronda termin√≥ en empate.</p>
    </ng-template>

    <p>
      Marcador:
      {{ s.players[0].name }} {{ s.players[0].score }} -
      {{ s.players[1].score }} {{ s.players[1].name }}
    </p>

    <button (click)="nextRound()">Siguiente ronda</button>
  </div>

  <!-- Log -->
  <div class="log-panel">
    <h3>Log</h3>
    <ul>
      <li
        *ngFor="let entry of s.log | slice:0:10"
        [innerHTML]="formatLog(entry)">
      </li>
    </ul>
  </div>
</div>

<ng-template #loading>
  <div class="duel-wrapper">
    <p>Cargando estado del duelo...</p>
  </div>
</ng-template>

<audio
  id="bg-music"
  src="assets/audio/bg-music.mp3"
  autoplay
  loop
  preload="auto"
  style="display: none;"
></audio>
