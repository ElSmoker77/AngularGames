<div class="duel-wrapper" *ngIf="state as s">
  <!-- T√≠tulo -->
  <h2>Duelo online ‚Äì Ronda {{ s.round }}</h2>


  <!-- SCOREBOARD -->
  <div class="scoreboard" *ngIf="s.players.length === 2">
    <span class="score-name">{{ s.players[0].name }}</span>
    <span class="score-value">{{ s.players[0].score }}</span>

    <span class="score-separator">-</span>

    <span class="score-value">{{ s.players[1].score }}</span>
    <span class="score-name">{{ s.players[1].name }}</span>
  </div>

  <!-- TIMER -->
  <div class="timer-block" *ngIf="timeLeft !== null">
    <div class="timer-label">
      <span *ngIf="timeLeft > 0; else timeEndTpl">
        Tiempo restante: {{ timeLeft }}s
      </span>
      <ng-template #timeEndTpl>
        <span class="timer-ended">Resolviendo acciones...</span>
      </ng-template>
    </div>

    <div class="time-bar">
      <div class="time-bar-fill" [style.width.%]="timePercent"></div>
    </div>
  </div>

  <!-- ESTADO -->
  <p class="status-text">
    {{ statusText }}
  </p>

  <!-- CARTAS DE JUGADORES -->
  <div class="players-row" *ngIf="myPlayer as me">
    <!-- YO -->
    <div
      class="player-card my-card"
      [ngClass]="me.lastAction || ''"
    >
      <div class="card-header">
        <h3>{{ me.name }}</h3>

        <div class="action-badge" *ngIf="me.lastAction">
          <span class="action-label">√öltima acci√≥n</span>
          <span class="action-icon">{{ getActionIcon(me.lastAction) }}</span>
          <span class="action-text">{{ getActionLabel(me.lastAction) }}</span>
        </div>
      </div>

      <div class="stat-row">
        <span>Vidas</span>
        <div class="icon-row">
          <span
            *ngFor="let h of getHearts(me)"
            class="heart"
            [class.empty]="!h"
            >‚ô•</span
          >
        </div>
      </div>

      <div class="stat-row">
        <span>Munici√≥n</span>
        <div class="icon-row">
          <span
            *ngFor="let a of getAmmoSlots(me)"
            class="bullet"
            [class.empty]="!a"
            >‚óè</span
          >
        </div>
      </div>
      <!-- Puntos ya est√°n en el marcador de arriba -->
    </div>

    <!-- RIVAL -->
    <div
      class="player-card opponent-card"
      *ngIf="opponent as op"
      [ngClass]="op.lastAction || ''"
    >
      <div class="card-header">
        <h3>{{ op.name }}</h3>

        <div class="action-badge" *ngIf="op.lastAction">
          <span class="action-label">√öltima acci√≥n</span>
          <span class="action-icon">{{ getActionIcon(op.lastAction) }}</span>
          <span class="action-text">{{ getActionLabel(op.lastAction) }}</span>
        </div>
      </div>

      <div class="stat-row">
        <span>Vidas</span>
        <div class="icon-row">
          <span
            *ngFor="let h of getHearts(op)"
            class="heart"
            [class.empty]="!h"
            >‚ô•</span
          >
        </div>
      </div>

      <div class="stat-row">
        <span>Munici√≥n</span>
        <div class="icon-row">
          <span
            *ngFor="let a of getAmmoSlots(op)"
            class="bullet"
            [class.empty]="!a"
            >‚óè</span
          >
        </div>
      </div>
    </div>
  </div>

  <!-- LOG: debajo de las cards -->
  <div class="log-panel" *ngIf="s.log?.length">
    <h3>Log</h3>
    <ul>
      <li *ngFor="let entry of s.log; let i = index"
    [class.log-highlight]="isFromLastTurn(i)">
        <span [innerHTML]="formatLog(entry)"></span>
      </li>
    </ul>
  </div>

  <!-- BOTONES: al final -->
  <div class="actions-panel" *ngIf="!s.isRoundOver">
    <h3>Eleg√≠ tu acci√≥n</h3>
    <div class="buttons">
      <button (click)="doAction('attack')" [disabled]="!canPlay">
        üí• Atacar
      </button>
      <button (click)="doAction('reload')" [disabled]="!canReload">
        üîÑ Recargar
      </button>
      <button (click)="doAction('block')" [disabled]="!canPlay">
        üõ°Ô∏è Bloquear
      </button>
    </div>
  </div>

  <!-- FIN DE RONDA -->
  <div class="gameover" *ngIf="s.isRoundOver">
    <h2 *ngIf="s.winnerId === null">Empate</h2>
    <h2 *ngIf="s.winnerId !== null">
      {{ getWinnerName(s.winnerId) }} gana la ronda
    </h2>

    <button (click)="nextRound()">Siguiente ronda</button>
  </div>
</div>

<audio id="bg-music" src="assets/audio/bg-music.mp3" autoplay loop></audio>
